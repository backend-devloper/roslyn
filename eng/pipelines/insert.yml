parameters:
  # These are actually a booleans but must be defined as string.
  # Parameters are evaluated at compile time, but all variables are strings at compile time.
  # So in order to pass a parameter that comes from a variable these must be typed as string.
  - name: createDraftPR
    type: string
    default: ''
  - name: autoComplete
    type: string
    default: ''
  - name: insertToolset
    type: string
    default: ''

  - name: clientId
    type: string
  - name: clientSecret
    type: string

  - name: componentBranchName
    type: string
  - name: vsBranchName
    type: string
  - name: componentBuildProjectName
    type: string
    default: ''
  - name: titlePrefix
    type: string
    default: ''

steps:
  - checkout: none

  - task: NuGetCommand@2
    displayName: 'Install RIT from Azure Artifacts'
    inputs:
      command: custom
      arguments: 'install RoslynTools.VisualStudioInsertionTool -PreRelease -Source https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json'

  # The next two steps define component repo variables for the insertion (if the build lives outside of devdiv).
  # Unfortunately there are a few limitations regarding variables and pipeline parameters inside ADO pipeline templates.
  #   1.  It is not possible to define variables in yaml along with steps in templates.
  #       See https://github.com/MicrosoftDocs/azure-devops-docs/issues/6890#issuecomment-594635314
  #       The workaround is to define them via scripts as below.
  #
  #   2.  Template parameters cannot be tested correctly inside scripts as it just replaces the ${{param}} with the value of the parameter.
  #       If the parameter is empty, it replaces with nothing which leads to errors in running the script.
  #       As such, we use a conditional step to test the template parameter and overwrite the template variable.

  # It is not possible to define template variables in yaml along with steps.
  # See https://github.com/MicrosoftDocs/azure-devops-docs/issues/6890#issuecomment-594635314
  # The workaround is to define them as below.
  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.ComponentAzdoUri]$('')"
      Write-Host "##vso[task.setvariable variable=Template.ComponentProjectName]$('')"
    displayName: Set Template Variables

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.ComponentAzdoUri]$($(System.CollectionUri))"
      Write-Host "##vso[task.setvariable variable=Template.ComponentProjectName]$(${{ parameters.componentBuildProjectName }})"
    displayName: Update Template Variables
    condition: ne('${{ parameters.componentBuildProjectName }}', '')

  # Now that everything is set, actually perform the insertion.
  - powershell: |
      mv RoslynTools.VisualStudioInsertionTool.* RIT
      .\RIT\tools\OneOffInsertion.ps1 `
        -autoComplete "${{ parameters.autoComplete }}" `
        -buildQueueName "$(Build.DefinitionName)" `
        -cherryPick "(default)" `
        -clientId "${{ parameters.clientId }}" `
        -clientSecret "${{ parameters.clientSecret }}" `
        -componentAzdoUri "$(Template.ComponentAzdoUri)" `
        -componentProjectName "$(Template.ComponentProjectName)" `
        -componentName "Roslyn" `
        -componentGitHubRepoName "dotnet/roslyn" `
        -componentBranchName "${{ parameters.componentBranchName }}" `
        -createDraftPR "${{ parameters.createDraftPR }}" `
        -defaultValueSentinel "(default)" `
        -dropPath "(default)" `
        -insertCore "(default)" `
        -insertDevDiv "(default)" `
        -insertionCount "1" `
        -insertToolset "${{ parameters.insertToolset }}" `
        -titlePrefix "${{ parameters.titlePrefix }}" `
        -titleSuffix "(default)" `
        -queueValidation "true" `
        -requiredValueSentinel "REQUIRED" `
        -reviewerGUID "6c25b447-1d90-4840-8fde-d8b22cb8733e" `
        -specificBuild "$(Build.BuildNumber)" `
        -updateAssemblyVersions "(default)" `
        -updateCoreXTLibraries "(default)" `
        -visualStudioBranchName "${{ parameters.vsBranchName }}" `
        -writePullRequest "prid.txt" `
    displayName: 'Run OneOffInsertion.ps1'

  - script: 'echo. && echo. && type "prid.txt" && echo. && echo.'
    displayName: 'Report PR URL'
