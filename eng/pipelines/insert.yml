parameters:
  # These are actually a booleans but must be defined as string.
  # Parameters are evaluated at compile time, but all variables are strings at compile time.
  # So in order to pass a parameter that comes from a variable these must be typed as string.
  - name: createDraftPR
    type: string
    default: ''
  - name: autoComplete
    type: string
    default: ''
  - name: insertToolset
    type: string
    default: ''

  - name: clientId
    type: string
  - name: clientSecret
    type: string

  - name: vsBranchName
    type: string
    default: ''
  - name: componentBuildProjectName
    type: string
    default: ''
  - name: titlePrefix
    type: string
    default: ''

  - name: sourceBranch
    type: string

steps:
  - checkout: none

  - task: NuGetCommand@2
    displayName: 'Install RIT from Azure Artifacts'
    inputs:
      command: custom
      arguments: 'install RoslynTools.VisualStudioInsertionTool -PreRelease -Source https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet-eng/nuget/v3/index.json'

  - powershell: |
      $response = Invoke-RestMethod -Headers @{Authorization = "Bearer $(System.AccessToken)"} "https://dev.azure.com/dnceng/internal/_apis/git/repositories/dotnet-roslyn/items?path=eng/config/PublishData.json&api-version=6.0"
      $branchName = "${{ parameters.sourceBranch }}"
      $branchData = $response.branches.$branchName
      if (!$branchData)
      {
        Write-Host "No PublishData found for branch '$branchName'. Using PublishData for branch 'main'."
        $branchData = $response.branches.main
      }

      Write-Host "##vso[task.setvariable variable=Template.CreateDraftPR]$($true)"
      Write-Host "##vso[task.setvariable variable=Template.AutoComplete]$($false)"
      Write-Host "##vso[task.setvariable variable=Template.TitlePrefix]$('')"
      Write-Host "##vso[task.setvariable variable=Template.InsertToolset]$($true)"
      Write-Host "##vso[task.setvariable variable=Template.ComponentAzdoUri]$('')"
      Write-Host "##vso[task.setvariable variable=Template.ComponentProjectName]$('')"

      Write-Host "##vso[task.setvariable variable=Template.ComponentBranchName]$branchName"
      Write-Host "##vso[task.setvariable variable=Template.VSBranchName]$($branchData.vsBranch)"

      if ($null -ne $branchData.insertionCreateDraftPR)
      {
        Write-Host "##vso[task.setvariable variable=Template.CreateDraftPR]$($branchData.insertionCreateDraftPR)"
      }

      if ($null -ne $branchData.insertionCreateDraftPR)
      {
        Write-Host "##vso[task.setvariable variable=Template.AutoComplete]$(-not $branchData.insertionCreateDraftPR)"
      }

      if ($null -ne $branchData.insertionTitlePrefix)
      {
        Write-Host "##vso[task.setvariable variable=Template.TitlePrefix]$($branchData.insertionTitlePrefix)"
      }

      if ($null -ne $branchData.insertToolset)
      {
        Write-Host "##vso[task.setvariable variable=Template.InsertToolset]$($branchData.insertToolset)"
      }

    displayName: Set Variables from PublishData

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.CreateDraftPR]$(${{ parameters.createDraftPR }})"
    displayName: Update createDraftPR Parameter
    condition: ne('${{ parameters.createDraftPR }}', '')

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.AutoComplete]$(${{ parameters.autoComplete }}")"
    displayName: Update autoComplete PR Parameter
    condition: ne('${{ parameters.autoComplete }}', '')

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.TitlePrefix]$('${{ parameters.titlePrefix }}')"
    displayName: Update titlePrefix Parameter
    condition: ne('${{ parameters.titlePrefix }}', '')

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.InsertToolset]$(${{ parameters.insertToolset }})"
    displayName: Update insertToolset Parameter
    condition: ne('${{ parameters.insertToolset }}', '')

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.VSBranchName]$('${{ parameters.vsBranchName }}')"
    displayName: Update vsBranchName Parameter
    condition: ne('${{ parameters.vsBranchName }}', '')

  - powershell: |
      Write-Host "##vso[task.setvariable variable=Template.ComponentAzdoUri]$('$(System.CollectionUri)')"
      Write-Host "##vso[task.setvariable variable=Template.ComponentProjectName]$('${{ parameters.componentBuildProjectName }}')"
    displayName: Update Component Repo Parameters
    condition: ne('${{ parameters.componentBuildProjectName }}', '')

  # Now that everything is set, actually perform the insertion.
  - powershell: |
      mv RoslynTools.VisualStudioInsertionTool.* RIT
      .\RIT\tools\OneOffInsertion.ps1 `
        -autoComplete "$(Template.AutoComplete)" `
        -buildQueueName "$(Build.DefinitionName)" `
        -cherryPick "(default)" `
        -clientId "${{ parameters.clientId }}" `
        -clientSecret "${{ parameters.clientSecret }}" `
        -componentAzdoUri "$(Template.ComponentAzdoUri)" `
        -componentProjectName "$(Template.ComponentProjectName)" `
        -componentName "Roslyn" `
        -componentGitHubRepoName "dotnet/roslyn" `
        -componentBranchName "$(Template.ComponentBranchName)" `
        -createDraftPR "$(Template.CreateDraftPR)" `
        -defaultValueSentinel "(default)" `
        -dropPath "(default)" `
        -insertCore "(default)" `
        -insertDevDiv "(default)" `
        -insertionCount "1" `
        -insertToolset "$(Template.InsertToolset)" `
        -titlePrefix "$(Template.TitlePrefix)" `
        -titleSuffix "(default)" `
        -queueValidation "true" `
        -requiredValueSentinel "REQUIRED" `
        -reviewerGUID "6c25b447-1d90-4840-8fde-d8b22cb8733e" `
        -specificBuild "$(Build.BuildNumber)" `
        -updateAssemblyVersions "(default)" `
        -updateCoreXTLibraries "(default)" `
        -visualStudioBranchName "$(Template.VSBranchName)" `
        -writePullRequest "prid.txt" `
    displayName: 'Run OneOffInsertion.ps1'

  - script: 'echo. && echo. && type "prid.txt" && echo. && echo.'
    displayName: 'Report PR URL'
