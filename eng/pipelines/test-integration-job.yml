parameters:
  - name: configuration
    type: string
    default: 'Debug'
  - name: oop64bit
    # Why string?  Parameters are evaluated at compile time, but all variables are strings at compile time.
    # So in order to pass a variable in as a parameter here, it must be string.
    type: string
    default: true
  - name: lspEditor
    type: string
    default: false

steps:
  - template: checkout-windows-task.yml

  - task: PowerShell@2
    displayName: Build and Test
    inputs:
      filePath: eng/build.ps1
      arguments: -ci -restore -build -pack -sign -publish -binaryLog -configuration $(configuration) -prepareMachine -testVsi -oop64bit:$$(oop64bit) -collectDumps -lspEditor:$$(lspEditor)

  - task: PublishTestResults@2
    displayName: Publish xUnit Test Results
    inputs:
      testRunner: XUnit
      testResultsFiles: $(Build.SourcesDirectory)\artifacts\TestResults\$(configuration)\*.xml
      mergeTestResults: true
      testRunTitle: '$(System.JobAttempt)-Integration $(configuration) OOP64_$(oop64bit)'
    condition: always()

  - task: PublishBuildArtifacts@1
    displayName: Publish Logs
    inputs:
      PathtoPublish: '$(Build.SourcesDirectory)\artifacts\log\$(configuration)'
      ArtifactName: '$(System.JobAttempt)-Logs $(configuration) OOP64_$(oop64bit) LspEditor_$(lspEditor) $(Build.BuildNumber)'
      publishLocation: Container
    continueOnError: true
    condition: not(succeeded())

  - task: PublishBuildArtifacts@1
    displayName: Publish Screenshots
    inputs:
      PathtoPublish: '$(Build.SourcesDirectory)\artifacts\bin\Microsoft.VisualStudio.LanguageServices.IntegrationTests\$(configuration)\net472\xUnitResults'
      ArtifactName: '$(System.JobAttempt)-Screenshots $(configuration) OOP64_$(oop64bit) LspEditor_$(lspEditor) $(Build.BuildNumber)'
      publishLocation: Container
    continueOnError: true
    condition: not(succeeded())
