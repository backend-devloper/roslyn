<?xml version="1.0" encoding="utf-8"?>
<!-- Licensed to the .NET Foundation under one or more agreements. The .NET Foundation licenses this file to you under the MIT license. See the LICENSE file in the project root for more information. -->
<Project>
  <Target Name="_CalculateCrossgen2Invocations">

    <Error Text="Unexpected value specified for EnableReadyToRunGeneration: '$(EnableReadyToRunGeneration)'"
           Condition="'$(EnableReadyToRunGeneration)' != 'win-x64'"/>

    <PropertyGroup>
      <_Crossgen2Path>$(NuGetPackageRoot)Microsoft.NETCore.App.crossgen2.$(EnableReadyToRunGeneration)\$(MicrosoftNetCoreAppPackagesVersion)\tools\crossgen2.dll</_Crossgen2Path>
      <_RuntimeLibraryPath>$(NuGetPackageRoot)Microsoft.NETCore.App.Runtime.$(EnableReadyToRunGeneration)\$(MicrosoftNetCoreAppPackagesVersion)\runtimes\$(EnableReadyToRunGeneration)\lib\net6.0</_RuntimeLibraryPath>      
      <_RunCrossgen2>false</_RunCrossgen2>
      <_RunCrossgen2 Condition="'$(EnableReadyToRunGeneration)' != '' and Exists('$(_Crossgen2Path)') and Exists('$(_RuntimeLibraryPath)')">true</_RunCrossgen2>
    </PropertyGroup>

    <ItemGroup>
      <_R2RRuntimeAssemblies Include="$(_RuntimeLibraryPath)\*.dll" />
    </ItemGroup>

    <PropertyGroup>
      <_R2ROptimizeAssemblyPath>@(IntermediateAssembly->'&quot;%(FullPath)&quot;')</_R2ROptimizeAssemblyPath>
      <_Crossgen2Args>$(_R2ROptimizeAssemblyPath) --out-near-input --targetarch:x64 --optimize --pdb</_Crossgen2Args>
      <_Crossgen2Args>$(_Crossgen2Args) @(_R2RRuntimeAssemblies->'--reference:&quot;%(FullPath)&quot;', ' ')</_Crossgen2Args>
    </PropertyGroup>
  </Target>

  <Target Name="RunCrossgen2"
          AfterTargets="CoreCompile"
          DependsOnTargets="_CalculateCrossgen2Invocations"
          Condition="'$(EnableReadyToRunGeneration)' != ''">

    <Message Text='Crossgen2 will be run with argument: $(_Crossgen2Path) $(_Crossgen2Args)'
             Importance="normal"/>

             
    <Exec Command='"$(DotNetTool)" exec "$(_Crossgen2Path)" $(_Crossgen2Args)' ConsoleToMSBuild="true" Condition="'$(_RunCrossgen2)' == 'true'" IgnoreExitCode="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="_Crossgen2Output" />
      <Output TaskParameter="ExitCode" PropertyName="_Crossgen2ErrorCode" />
    </Exec>

    <Message Text="$(_Crossgen2Output)"
             Importance="low"
             Condition="'$(_RunCrossgen2)' == 'true'" />

    <Error Text="Crossgen2 failed with exit code $(_Crossgen2ErrorCode)."
           Condition="'$(_RunCrossgen2)' == 'true' and '$(_Crossgen2ErrorCode)' != '0'" />
  </Target>

  <ItemGroup>
    <PackageReference Include="Microsoft.NETCore.App.crossgen2.win-x64"  Version="$(MicrosoftNetCoreAppPackagesVersion)" ExcludeAssets="all" PrivateAssets="all" />
    <PackageReference Include="Microsoft.NETCore.App.Runtime.win-x64"  Version="$(MicrosoftNetCoreAppPackagesVersion)" ExcludeAssets="all" PrivateAssets="all" />
  </ItemGroup>
</Project>
